# docker-compose.yml â€” local development stack for clinical-agentic-control-plane
# Spins up PostgreSQL, Redis, OPA, and the control-plane API.

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: cacp
      POSTGRES_USER: cacp
      POSTGRES_PASSWORD: cacp_local
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cacp"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  opa:
    image: openpolicyagent/opa:latest-static
    ports:
      - "8181:8181"
    command:
      - run
      - --server
      - --addr=0.0.0.0:8181
      - --config-file=/etc/opa/config.yaml
      - /policies
    volumes:
      - ./opa/config.yaml:/etc/opa/config.yaml:ro
      # Mount policies from clinic-gitops-config if available
      - ../../clinic-gitops-config/environments/dev/policies/opa:/policies:ro

  api:
    build:
      context: ../..
      dockerfile: infra/local/Dockerfile.dev
    ports:
      - "8000:8000"
    environment:
      CACP_PG_DSN: postgresql://cacp:cacp_local@postgres:5432/cacp
      CACP_REDIS_URL: redis://redis:6379/0
      CACP_OPA_URL: http://opa:8181
      CACP_HMAC_SECRET: local-dev-secret-change-me
      CACP_ENVIRONMENT: dev
      CACP_GITHUB_WEBHOOK_SECRET: change-me-webhook-secret
      LOG_LEVEL: debug
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      opa:
        condition: service_started

volumes:
  pgdata:
